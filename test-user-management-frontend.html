<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Management Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
        }

        button {
            margin: 5px;
            padding: 10px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .user-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
        }

        input,
        select {
            margin: 5px;
            padding: 5px;
        }

        .form-group {
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>User Management Frontend Test</h1>

    <div class="section">
        <h2>Step 1: Clear Old Tokens & Fresh Login</h2>
        <button onclick="clearTokens()">Clear Old Tokens</button>
        <button onclick="adminLogin()">Admin Login</button>
        <div id="authStatus"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test User Management CRUD</h2>
        <button onclick="fetchUsers()">Fetch Users</button>
        <button onclick="testAddUser()">Test Add User</button>
        <button onclick="testEditUser()">Test Edit First User</button>
        <button onclick="testDeleteUser()">Test Delete Last User</button>
        <div id="userManagementStatus"></div>
        <div id="usersList"></div>
    </div>

    <div class="section">
        <h2>Manual User Management</h2>
        <div class="form-group">
            <label>Name: <input type="text" id="userName" placeholder="Enter user name"></label>
        </div>
        <div class="form-group">
            <label>Email: <input type="email" id="userEmail" placeholder="Enter user email"></label>
        </div>
        <div class="form-group">
            <label>Password: <input type="password" id="userPassword" placeholder="Enter password"></label>
        </div>
        <div class="form-group">
            <label>Role:
                <select id="userRole">
                    <option value="customer">Customer</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                </select>
            </label>
        </div>
        <div class="form-group">
            <label>Status:
                <select id="userStatus">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Pending">Pending</option>
                </select>
            </label>
        </div>
        <button onclick="addManualUser()">Add User</button>
        <div id="manualUserStatus"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            document.getElementById('authStatus').innerHTML = '<span class="success">✓ Tokens cleared</span>';
        }

        async function adminLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@toollink.com',
                        password: 'admin123'
                    })
                });

                const data = await response.json();

                if (response.ok && data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    document.getElementById('authStatus').innerHTML = `<span class="success">✓ Admin logged in successfully</span><br>Token: ${data.accessToken.substring(0, 20)}...`;
                } else {
                    document.getElementById('authStatus').innerHTML = `<span class="error">✗ Login failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `<span class="error">✗ Login error: ${error.message}</span>`;
            }
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('accessToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    displayUsers(data.users || data);
                    document.getElementById('userManagementStatus').innerHTML = `<span class="success">✓ Users fetched successfully (${(data.users || data).length} users)</span>`;
                } else {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Fetch failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Fetch error: ${error.message}</span>`;
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<h3>Current Users:</h3>';

            users.forEach((user, index) => {
                usersList.innerHTML += `
                    <div class="user-item">
                        <strong>#${index + 1}</strong> -
                        Name: ${user.fullName || user.name} |
                        Email: ${user.email} |
                        Role: ${user.role} |
                        Status: ${user.isActive !== undefined ? (user.isActive ? 'Active' : 'Inactive') : user.status} |
                        ID: ${user._id || user.id}
                    </div>
                `;
            });
        }

        async function testAddUser() {
            try {
                const testUser = {
                    fullName: 'Test User ' + Date.now(),
                    email: 'test' + Date.now() + '@example.com',
                    password: 'testpass123',
                    role: 'customer',
                    isActive: true
                };

                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(testUser)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="success">✓ User added successfully</span>`;
                    fetchUsers(); // Refresh the list
                } else {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Add failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Add error: ${error.message}</span>`;
            }
        }

        async function addManualUser() {
            try {
                const name = document.getElementById('userName').value;
                const email = document.getElementById('userEmail').value;
                const password = document.getElementById('userPassword').value;
                const role = document.getElementById('userRole').value;
                const status = document.getElementById('userStatus').value;

                if (!name || !email || !password) {
                    document.getElementById('manualUserStatus').innerHTML = '<span class="error">✗ Please fill in all required fields</span>';
                    return;
                }

                const userData = {
                    fullName: name,
                    email: email,
                    password: password,
                    role: role,
                    isActive: status === 'Active'
                };

                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('manualUserStatus').innerHTML = `<span class="success">✓ User "${name}" added successfully</span>`;
                    // Clear form
                    document.getElementById('userName').value = '';
                    document.getElementById('userEmail').value = '';
                    document.getElementById('userPassword').value = '';
                    fetchUsers(); // Refresh the list
                } else {
                    document.getElementById('manualUserStatus').innerHTML = `<span class="error">✗ Add failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('manualUserStatus').innerHTML = `<span class="error">✗ Add error: ${error.message}</span>`;
            }
        }

        // Store users for edit/delete operations
        let currentUsers = [];

        async function fetchUsersForOperations() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    currentUsers = data.users || data;
                    return currentUsers;
                }
            } catch (error) {
                console.error('Error fetching users:', error);
            }
            return [];
        }

        async function testEditUser() {
            const users = await fetchUsersForOperations();
            if (users.length === 0) {
                document.getElementById('userManagementStatus').innerHTML = '<span class="error">✗ No users to edit</span>';
                return;
            }

            const firstUser = users[0];
            try {
                const updatedData = {
                    fullName: firstUser.fullName || firstUser.name + ' (Edited)',
                    email: firstUser.email,
                    role: firstUser.role,
                    isActive: true
                };

                const response = await fetch(`${API_BASE}/users/${firstUser._id || firstUser.id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(updatedData)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="success">✓ User edited successfully</span>`;
                    fetchUsers(); // Refresh the list
                } else {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Edit failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Edit error: ${error.message}</span>`;
            }
        }

        async function testDeleteUser() {
            const users = await fetchUsersForOperations();
            if (users.length === 0) {
                document.getElementById('userManagementStatus').innerHTML = '<span class="error">✗ No users to delete</span>';
                return;
            }

            const lastUser = users[users.length - 1];

            // Don't delete admin user
            if (lastUser.role === 'admin') {
                document.getElementById('userManagementStatus').innerHTML = '<span class="error">✗ Cannot delete admin user</span>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${lastUser._id || lastUser.id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="success">✓ User deleted successfully</span>`;
                    fetchUsers(); // Refresh the list
                } else {
                    document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Delete failed: ${data.message || 'Unknown error'}</span>`;
                }
            } catch (error) {
                document.getElementById('userManagementStatus').innerHTML = `<span class="error">✗ Delete error: ${error.message}</span>`;
            }
        }
    </script>
</body>

</html>
