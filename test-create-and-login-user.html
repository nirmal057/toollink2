<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolLink - Create New User & Test Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .credentials-display {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 20px;
            display: none;
        }

        .credential-item {
            margin: 10px 0;
            font-family: monospace;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .login-test-section {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            display: none;
        }

        .step-number {
            display: inline-block;
            background-color: #007bff;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            margin-right: 10px;
        }

        .admin-note {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ToolLink - Create New User & Test Login</h1>

        <div class="admin-note">
            <strong>Note:</strong> You need to be logged in as an admin to create new users. Make sure you have admin
            credentials.
        </div>

        <!-- Step 1: Admin Login -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">1</span>Admin Login (Required)
            </div>
            <div class="form-group">
                <label for="adminEmail">Admin Email:</label>
                <input type="email" id="adminEmail" value="admin@toollink.com" placeholder="Enter admin email">
            </div>
            <div class="form-group">
                <label for="adminPassword">Admin Password:</label>
                <input type="password" id="adminPassword" value="admin123" placeholder="Enter admin password">
            </div>
            <button class="btn" onclick="adminLogin()">Login as Admin</button>
            <div id="adminStatus"></div>
        </div>

        <!-- Step 2: Create New User -->
        <div class="section" id="createUserSection" style="display: none;">
            <div class="section-title">
                <span class="step-number">2</span>Create New User
            </div>
            <div class="form-group">
                <label for="newUsername">Username:</label>
                <input type="text" id="newUsername" placeholder="Enter username (min 3 characters)">
            </div>
            <div class="form-group">
                <label for="newEmail">Email:</label>
                <input type="email" id="newEmail" placeholder="Enter email address">
            </div>
            <div class="form-group">
                <label for="newPassword">Password:</label>
                <input type="password" id="newPassword" placeholder="Enter password (min 6 characters)">
            </div>
            <div class="form-group">
                <label for="newFullName">Full Name:</label>
                <input type="text" id="newFullName" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="newPhone">Phone:</label>
                <input type="text" id="newPhone" placeholder="Enter phone number">
            </div>
            <div class="form-group">
                <label for="newRole">Role:</label>
                <select id="newRole">
                    <option value="">Select Role</option>
                    <option value="admin">Admin</option>
                    <option value="warehouse">Warehouse Manager</option>
                    <option value="cashier">Cashier</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newAddress">Address (Optional):</label>
                <input type="text" id="newAddress" placeholder="Enter address">
            </div>
            <button class="btn" onclick="createUser()">Create User</button>
            <div id="createUserStatus"></div>

            <!-- Display created user credentials -->
            <div class="credentials-display" id="credentialsDisplay">
                <div class="section-title">✅ User Created Successfully!</div>
                <p><strong>New User Login Credentials:</strong></p>
                <div class="credential-item">
                    <strong>Email:</strong> <span id="createdEmail"></span>
                </div>
                <div class="credential-item">
                    <strong>Password:</strong> <span id="createdPassword"></span>
                </div>
                <div class="credential-item">
                    <strong>Role:</strong> <span id="createdRole"></span>
                </div>
                <div class="credential-item">
                    <strong>Full Name:</strong> <span id="createdFullName"></span>
                </div>
            </div>
        </div>

        <!-- Step 3: Test New User Login -->
        <div class="section login-test-section" id="loginTestSection">
            <div class="section-title">
                <span class="step-number">3</span>Test New User Login
            </div>
            <p>Now test if you can login with the newly created user:</p>
            <div class="form-group">
                <label for="testEmail">Email:</label>
                <input type="email" id="testEmail" readonly>
            </div>
            <div class="form-group">
                <label for="testPassword">Password:</label>
                <input type="password" id="testPassword" readonly>
            </div>
            <button class="btn btn-success" onclick="testNewUserLogin()">Test Login with New User</button>
            <div id="loginTestStatus"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let adminToken = null;
        let createdUserCredentials = null;

        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="${type}" style="margin-top: 10px;">${message}</div>`;
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showStatus('adminStatus', 'Please enter admin email and password', 'error');
                return;
            }

            try {
                showStatus('adminStatus', 'Logging in as admin...', 'info');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.user.role === 'admin') {
                    adminToken = data.accessToken;
                    showStatus('adminStatus',
                        `✅ Admin login successful!<br>Welcome, ${data.user.fullName}`,
                        'success'
                    );

                    // Show the create user section
                    document.getElementById('createUserSection').style.display = 'block';
                } else {
                    showStatus('adminStatus',
                        `❌ Admin login failed: ${data.message || 'Invalid credentials or not an admin'}`,
                        'error'
                    );
                }
            } catch (error) {
                showStatus('adminStatus',
                    `❌ Network error: ${error.message}`,
                    'error'
                );
            }
        }

        async function createUser() {
            if (!adminToken) {
                showStatus('createUserStatus', 'Please login as admin first', 'error');
                return;
            }

            const userData = {
                username: document.getElementById('newUsername').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                fullName: document.getElementById('newFullName').value,
                phone: document.getElementById('newPhone').value,
                role: document.getElementById('newRole').value,
                address: document.getElementById('newAddress').value
            };

            // Validation
            if (!userData.username || userData.username.length < 3) {
                showStatus('createUserStatus', 'Username must be at least 3 characters', 'error');
                return;
            }
            if (!userData.email) {
                showStatus('createUserStatus', 'Email is required', 'error');
                return;
            }
            if (!userData.password || userData.password.length < 6) {
                showStatus('createUserStatus', 'Password must be at least 6 characters', 'error');
                return;
            }
            if (!userData.fullName || userData.fullName.length < 2) {
                showStatus('createUserStatus', 'Full name must be at least 2 characters', 'error');
                return;
            }
            if (!userData.role) {
                showStatus('createUserStatus', 'Please select a role', 'error');
                return;
            }

            try {
                showStatus('createUserStatus', 'Creating user...', 'info');

                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    createdUserCredentials = {
                        email: userData.email,
                        password: userData.password,
                        role: userData.role,
                        fullName: userData.fullName
                    };

                    showStatus('createUserStatus',
                        `✅ User created successfully!<br>User ID: ${data.user.id}`,
                        'success'
                    );

                    // Display credentials
                    document.getElementById('createdEmail').textContent = userData.email;
                    document.getElementById('createdPassword').textContent = userData.password;
                    document.getElementById('createdRole').textContent = userData.role;
                    document.getElementById('createdFullName').textContent = userData.fullName;
                    document.getElementById('credentialsDisplay').style.display = 'block';

                    // Prepare test login section
                    document.getElementById('testEmail').value = userData.email;
                    document.getElementById('testPassword').value = userData.password;
                    document.getElementById('loginTestSection').style.display = 'block';

                    // Clear the form
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newEmail').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('newFullName').value = '';
                    document.getElementById('newPhone').value = '';
                    document.getElementById('newRole').value = '';
                    document.getElementById('newAddress').value = '';
                } else {
                    showStatus('createUserStatus',
                        `❌ Failed to create user: ${data.error || data.message}`,
                        'error'
                    );
                }
            } catch (error) {
                showStatus('createUserStatus',
                    `❌ Network error: ${error.message}`,
                    'error'
                );
            }
        }

        async function testNewUserLogin() {
            if (!createdUserCredentials) {
                showStatus('loginTestStatus', 'No user credentials to test', 'error');
                return;
            }

            try {
                showStatus('loginTestStatus', 'Testing login with new user...', 'info');

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: createdUserCredentials.email,
                        password: createdUserCredentials.password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('loginTestStatus',
                        `🎉 SUCCESS! New user can login!<br>
                        <strong>Login Details:</strong><br>
                        Email: ${data.user.email}<br>
                        Name: ${data.user.fullName}<br>
                        Role: ${data.user.role}<br>
                        User ID: ${data.user.id}<br>
                        ✅ Authentication token received`,
                        'success'
                    );
                } else {
                    showStatus('loginTestStatus',
                        `❌ Login failed: ${data.message}`,
                        'error'
                    );
                }
            } catch (error) {
                showStatus('loginTestStatus',
                    `❌ Network error: ${error.message}`,
                    'error'
                );
            }
        }

        // Auto-fill some sample data for quick testing
        function fillSampleData() {
            const timestamp = Date.now();
            document.getElementById('newUsername').value = `testuser${timestamp}`;
            document.getElementById('newEmail').value = `test${timestamp}@toollink.com`;
            document.getElementById('newPassword').value = 'test123';
            document.getElementById('newFullName').value = 'Test User';
            document.getElementById('newPhone').value = '1234567890';
            document.getElementById('newRole').value = 'customer';
            document.getElementById('newAddress').value = '123 Test Street';
        }

        // Add a button to fill sample data
        window.addEventListener('load', function () {
            const createSection = document.getElementById('createUserSection');
            const sampleButton = document.createElement('button');
            sampleButton.textContent = 'Fill Sample Data';
            sampleButton.className = 'btn';
            sampleButton.style.marginBottom = '10px';
            sampleButton.style.backgroundColor = '#6c757d';
            sampleButton.onclick = fillSampleData;

            const titleElement = createSection.querySelector('.section-title');
            titleElement.parentNode.insertBefore(sampleButton, titleElement.nextSibling);
        });
    </script>
</body>

</html>
