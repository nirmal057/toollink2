<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Creation Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }

        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Test User Creation - Notification Fix Verification</h1>

        <form id="userForm">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div class="form-group">
                <label for="fullName">Full Name:</label>
                <input type="text" id="fullName" name="fullName" required>
            </div>

            <div class="form-group">
                <label for="phone">Phone:</label>
                <input type="text" id="phone" name="phone">
            </div>

            <div class="form-group">
                <label for="role">Role:</label>
                <select id="role" name="role" required>
                    <option value="customer">Customer</option>
                    <option value="cashier">Cashier</option>
                    <option value="warehouse">Warehouse</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <button type="submit">Create User</button>
            <button type="button" onclick="testNotifications()">Test Notifications</button>
        </form>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3000';
        let authToken = null;

        // Auto-login as admin when page loads
        window.onload = async () => {
            try {
                const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@toollink.com',
                        password: 'admin123'
                    })
                });

                const loginData = await loginResponse.json();
                if (loginData.success && loginData.accessToken) {
                    authToken = loginData.accessToken;
                    console.log('‚úÖ Auto-logged in as admin');

                    // Pre-fill form with test data
                    document.getElementById('username').value = `testuser_${Date.now()}`;
                    document.getElementById('email').value = `test_${Date.now()}@example.com`;
                    document.getElementById('password').value = 'TestPassword123!';
                    document.getElementById('fullName').value = 'Test User for Notification Fix';
                    document.getElementById('phone').value = '0771234567';
                    document.getElementById('role').value = 'customer';
                } else {
                    console.error('‚ùå Failed to auto-login');
                }
            } catch (error) {
                console.error('‚ùå Auto-login error:', error);
            }
        };

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîÑ Creating user...';

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Not authenticated. Please refresh the page.';
                return;
            }

            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);

            try {
                // Step 1: Create user
                console.log('üìù Creating user...');
                const createResponse = await fetch(`${BASE_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const createData = await createResponse.json();

                if (!createResponse.ok) {
                    throw new Error(`User creation failed: ${createData.error || createData.message}`);
                }

                console.log('‚úÖ User created successfully');

                // Step 2: Test notification endpoint (this was causing the error)
                console.log('üîî Testing notification endpoint...');
                const notificationResponse = await fetch(`${BASE_URL}/api/notifications/unread-count`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const notificationData = await notificationResponse.json();

                if (!notificationResponse.ok) {
                    throw new Error(`Notification test failed: ${notificationData.error}`);
                }

                console.log('‚úÖ Notification endpoint working');

                // Step 3: Get updated user list
                console.log('üë• Fetching updated user list...');
                const usersResponse = await fetch(`${BASE_URL}/api/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const usersData = await usersResponse.json();
                const users = usersData.data || usersData || [];

                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ SUCCESS! User creation flow completed without errors!

User Created:
- Username: ${createData.data?.username || createData.username}
- Email: ${createData.data?.email || createData.email}
- Role: ${createData.data?.role || createData.role}

Notification Test:
- Unread count: ${notificationData.data?.count || 0}
- Status: Working ‚úÖ

User List:
- Total users: ${users.length}
- Latest user: ${users[users.length - 1]?.username || 'Unknown'}

üéâ The notification error has been fixed!`;

            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}

Check the console for more details.`;
            }
        });

        async function testNotifications() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'üîÑ Testing notification endpoints...';

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Not authenticated. Please refresh the page.';
                return;
            }

            try {
                // Test unread count
                const unreadResponse = await fetch(`${BASE_URL}/api/notifications/unread-count`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const unreadData = await unreadResponse.json();

                // Test main notifications
                const notificationsResponse = await fetch(`${BASE_URL}/api/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const notificationsData = await notificationsResponse.json();

                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Notification endpoints working correctly!

Unread Count: ${unreadData.data?.count || 0}
Total Notifications: ${notificationsData.data?.length || 0}

Available Notifications:
${(notificationsData.data || []).map(n => `- ${n.title}: ${n.message}`).join('\n')}`;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Notification test failed: ${error.message}`;
            }
        }
    </script>
</body>

</html>
