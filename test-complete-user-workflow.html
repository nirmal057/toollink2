<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToolLink - Complete User Creation & Login Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #229954;
        }

        .btn.warning {
            background: #f39c12;
        }

        .btn.warning:hover {
            background: #e67e22;
        }

        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }

        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .user-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .user-card h4 {
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .user-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            font-weight: bold;
            color: #6c757d;
        }

        .detail-value {
            color: #495057;
            font-family: monospace;
        }

        .workflow-steps {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
        }

        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        .step-text {
            color: #2c3e50;
        }

        .step.completed {
            background: #d4edda;
        }

        .step.completed .step-number {
            background: #28a745;
        }

        .step.active {
            background: #fff3cd;
        }

        .step.active .step-number {
            background: #ffc107;
            color: #212529;
        }

        .quick-users {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .quick-user {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quick-user:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .quick-user.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .quick-user h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .quick-user p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .role-admin {
            background: #dc3545;
        }

        .role-warehouse {
            background: #6f42c1;
        }

        .role-cashier {
            background: #fd7e14;
        }

        .role-customer {
            background: #20c997;
        }

        .role-driver {
            background: #0d6efd;
        }

        .role-editor {
            background: #6610f2;
        }

        .role-user {
            background: #6c757d;
        }

        .test-results {
            margin-top: 2rem;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-success {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .status-pending {
            color: #ffc107;
        }

        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .user-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header Section -->
        <div class="section full-width">
            <div class="header">
                <h1>üîÑ Complete User Creation & Login Workflow Test</h1>
                <p>Test the full process: Add user ‚Üí Login immediately with their credentials</p>
            </div>

            <div class="workflow-steps">
                <h3>üìã Test Workflow</h3>
                <div class="step" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">Login as admin to access user management</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">Create a new user (cashier, customer, etc.)</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">Immediately test login with the new user's credentials</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-text">Verify the user can access appropriate features based on their role</div>
                </div>
            </div>
        </div>

        <!-- Admin Login Section -->
        <div class="section">
            <h3>üîê Step 1: Admin Login</h3>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminEmail">Admin Email:</label>
                    <input type="email" id="adminEmail" value="admin@toollink.com" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn" id="adminLoginBtn">
                    üîë Login as Admin
                </button>
            </form>
            <div id="adminLoginResult"></div>
        </div>

        <!-- User Creation Section -->
        <div class="section">
            <h3>üë§ Step 2: Create New User</h3>

            <div class="quick-users">
                <div class="quick-user" data-role="cashier">
                    <h4>üí∞ Cashier</h4>
                    <p>Point of sale operations</p>
                    <span class="role-badge role-cashier">Cashier</span>
                </div>
                <div class="quick-user" data-role="customer">
                    <h4>üõí Customer</h4>
                    <p>Customer access</p>
                    <span class="role-badge role-customer">Customer</span>
                </div>
                <div class="quick-user" data-role="warehouse">
                    <h4>üì¶ Warehouse</h4>
                    <p>Warehouse management</p>
                    <span class="role-badge role-warehouse">Warehouse</span>
                </div>
                <div class="quick-user" data-role="driver">
                    <h4>üöö Driver</h4>
                    <p>Delivery operations</p>
                    <span class="role-badge role-driver">Driver</span>
                </div>
            </div>

            <form id="createUserForm" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label for="newUsername">Username:</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newEmail">Email:</label>
                    <input type="email" id="newEmail" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Password:</label>
                    <input type="text" id="newPassword" value="password123" required>
                </div>
                <div class="form-group">
                    <label for="newFullName">Full Name:</label>
                    <input type="text" id="newFullName" required>
                </div>
                <div class="form-group">
                    <label for="newRole">Role:</label>
                    <select id="newRole" required>
                        <option value="">Select Role</option>
                        <option value="cashier">Cashier</option>
                        <option value="customer">Customer</option>
                        <option value="warehouse">Warehouse</option>
                        <option value="driver">Driver</option>
                        <option value="editor">Editor</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="createUserBtn" disabled>
                    ‚ûï Create User
                </button>
            </form>
            <div id="createUserResult"></div>
        </div>

        <!-- New User Login Test Section -->
        <div class="section full-width">
            <h3>üéØ Step 3: Test Login with New User</h3>

            <div id="newUserCard" style="display: none;">
                <div class="user-card">
                    <h4>üìù New User Created</h4>
                    <div class="user-details">
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value" id="createdEmail">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Username:</span>
                            <span class="detail-value" id="createdUsername">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Password:</span>
                            <span class="detail-value" id="createdPassword">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Role:</span>
                            <span class="detail-value" id="createdRole">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <form id="newUserLoginForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 1rem; align-items: end;">
                    <div class="form-group">
                        <label for="testEmail">Login Email/Username:</label>
                        <input type="text" id="testEmail" placeholder="Will be filled automatically" required>
                    </div>
                    <div class="form-group">
                        <label for="testPassword">Password:</label>
                        <input type="password" id="testPassword" placeholder="Will be filled automatically" required>
                    </div>
                    <button type="submit" class="btn success" id="testLoginBtn" disabled>
                        üöÄ Test Login
                    </button>
                </div>
            </form>
            <div id="newUserLoginResult"></div>
        </div>

        <!-- Test Results Section -->
        <div class="section full-width">
            <h3>üìä Test Results & User Dashboard Access</h3>

            <div class="test-results">
                <div class="test-item">
                    <span>Admin Authentication</span>
                    <span class="status-icon status-pending" id="adminAuthStatus">‚è≥</span>
                </div>
                <div class="test-item">
                    <span>User Creation</span>
                    <span class="status-icon status-pending" id="userCreationStatus">‚è≥</span>
                </div>
                <div class="test-item">
                    <span>New User Login</span>
                    <span class="status-icon status-pending" id="newUserAuthStatus">‚è≥</span>
                </div>
                <div class="test-item">
                    <span>Role-based Dashboard Access</span>
                    <span class="status-icon status-pending" id="dashboardAccessStatus">‚è≥</span>
                </div>
            </div>

            <div id="dashboardData" style="display: none;">
                <h4>üéõÔ∏è User Dashboard Data</h4>
                <pre id="dashboardOutput"></pre>
            </div>

            <div id="systemInfo">
                <h4>üîß System Information</h4>
                <pre id="systemOutput">Waiting for tests to run...</pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let adminToken = null;
        let createdUser = null;
        let newUserToken = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateSystemInfo('üîÑ Page loaded, ready to begin tests...');
        });

        function setupEventListeners() {
            // Admin login form
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);

            // User creation form
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);

            // New user login form
            document.getElementById('newUserLoginForm').addEventListener('submit', handleNewUserLogin);

            // Quick user selection
            document.querySelectorAll('.quick-user').forEach(card => {
                card.addEventListener('click', () => selectQuickUser(card));
            });
        }

        function selectQuickUser(selectedCard) {
            // Remove previous selections
            document.querySelectorAll('.quick-user').forEach(card => {
                card.classList.remove('selected');
            });

            // Select current card
            selectedCard.classList.add('selected');

            const role = selectedCard.dataset.role;
            const roleName = selectedCard.querySelector('h4').textContent.replace(/[^a-zA-Z\s]/g, '').trim();

            // Fill form with template data
            document.getElementById('newUsername').value = `${role}user`;
            document.getElementById('newEmail').value = `${role}@toollink.com`;
            document.getElementById('newFullName').value = `Test ${roleName} User`;
            document.getElementById('newRole').value = role;

            // Enable create button if admin is logged in
            if (adminToken) {
                document.getElementById('createUserBtn').disabled = false;
            }
        }

        async function handleAdminLogin(e) {
            e.preventDefault();

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const button = document.getElementById('adminLoginBtn');
            const resultDiv = document.getElementById('adminLoginResult');

            button.disabled = true;
            button.textContent = 'üîÑ Logging in...';
            updateStep('step1', 'active');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    adminToken = data.accessToken;

                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ Admin Login Successful!</h4>
                            <p><strong>Welcome:</strong> ${data.user.fullName}</p>
                            <p><strong>Role:</strong> ${data.user.role}</p>
                            <p>You can now create new users.</p>
                        </div>
                    `;

                    updateStep('step1', 'completed');
                    updateStep('step2', 'active');
                    updateStatus('adminAuthStatus', 'success');

                    // Enable user creation if a role is selected
                    const selectedRole = document.querySelector('.quick-user.selected');
                    if (selectedRole) {
                        document.getElementById('createUserBtn').disabled = false;
                    }

                    updateSystemInfo(`‚úÖ Admin authenticated: ${data.user.fullName} (${data.user.role})\nüîë Token received and stored\n‚è∞ ${new Date().toLocaleString()}`);

                } else {
                    throw new Error(data.message || data.error || 'Login failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>‚ùå Admin Login Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                updateStatus('adminAuthStatus', 'error');
                updateSystemInfo(`‚ùå Admin login failed: ${error.message}\n‚è∞ ${new Date().toLocaleString()}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üîë Login as Admin';
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();

            if (!adminToken) {
                alert('Please login as admin first!');
                return;
            }

            const userData = {
                username: document.getElementById('newUsername').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                fullName: document.getElementById('newFullName').value,
                role: document.getElementById('newRole').value
            };

            const button = document.getElementById('createUserBtn');
            const resultDiv = document.getElementById('createUserResult');

            button.disabled = true;
            button.textContent = 'üîÑ Creating User...';

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    createdUser = {
                        username: userData.username,
                        email: userData.email,
                        password: userData.password,
                        fullName: userData.fullName,
                        role: userData.role,
                        id: data.user.id
                    };

                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ User Created Successfully!</h4>
                            <p><strong>User ID:</strong> ${data.user.id}</p>
                            <p><strong>Email:</strong> ${userData.email}</p>
                            <p><strong>Role:</strong> ${userData.role}</p>
                            <p>Ready to test login!</p>
                        </div>
                    `;

                    // Show the new user card and fill login form
                    document.getElementById('newUserCard').style.display = 'block';
                    document.getElementById('createdEmail').textContent = userData.email;
                    document.getElementById('createdUsername').textContent = userData.username;
                    document.getElementById('createdPassword').textContent = userData.password;
                    document.getElementById('createdRole').textContent = userData.role;

                    // Fill the test login form
                    document.getElementById('testEmail').value = userData.email;
                    document.getElementById('testPassword').value = userData.password;
                    document.getElementById('testLoginBtn').disabled = false;

                    updateStep('step2', 'completed');
                    updateStep('step3', 'active');
                    updateStatus('userCreationStatus', 'success');

                    updateSystemInfo(`‚úÖ User created successfully!\nüë§ ${userData.fullName} (${userData.email})\nüé≠ Role: ${userData.role}\nüÜî ID: ${data.user.id}\n‚è∞ ${new Date().toLocaleString()}`);

                } else {
                    throw new Error(data.message || data.error || 'User creation failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>‚ùå User Creation Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                updateStatus('userCreationStatus', 'error');
                updateSystemInfo(`‚ùå User creation failed: ${error.message}\n‚è∞ ${new Date().toLocaleString()}`);
            } finally {
                button.disabled = false;
                button.textContent = '‚ûï Create User';
            }
        }

        async function handleNewUserLogin(e) {
            e.preventDefault();

            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const button = document.getElementById('testLoginBtn');
            const resultDiv = document.getElementById('newUserLoginResult');

            button.disabled = true;
            button.textContent = 'üîÑ Testing Login...';

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    newUserToken = data.accessToken;

                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>üéâ New User Login Successful!</h4>
                            <p><strong>Welcome:</strong> ${data.user.fullName}</p>
                            <p><strong>Email:</strong> ${data.user.email}</p>
                            <p><strong>Role:</strong> ${data.user.role}</p>
                            <p><strong>User Active:</strong> ${data.user.isActive ? 'Yes' : 'No'}</p>
                            <p><strong>User Approved:</strong> ${data.user.isApproved ? 'Yes' : 'No'}</p>
                            <p>üéØ Login immediately after creation works perfectly!</p>
                        </div>
                    `;

                    updateStep('step3', 'completed');
                    updateStep('step4', 'active');
                    updateStatus('newUserAuthStatus', 'success');

                    updateSystemInfo(`üéâ NEW USER LOGIN SUCCESS!\nüë§ ${data.user.fullName}\nüìß ${data.user.email}\nüé≠ Role: ${data.user.role}\n‚úÖ Active: ${data.user.isActive}\n‚úÖ Approved: ${data.user.isApproved}\n‚è∞ ${new Date().toLocaleString()}`);

                    // Test dashboard access
                    await testDashboardAccess();

                } else {
                    throw new Error(data.message || data.error || 'Login failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>‚ùå New User Login Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>This might indicate an issue with the user creation or authentication system.</p>
                    </div>
                `;
                updateStatus('newUserAuthStatus', 'error');
                updateSystemInfo(`‚ùå New user login failed: ${error.message}\n‚è∞ ${new Date().toLocaleString()}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Test Login';
            }
        }

        async function testDashboardAccess() {
            if (!newUserToken) return;

            try {
                const response = await fetch(`${API_BASE}/users/dashboard`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${newUserToken}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    document.getElementById('dashboardData').style.display = 'block';
                    document.getElementById('dashboardOutput').textContent = JSON.stringify(data.data, null, 2);

                    updateStep('step4', 'completed');
                    updateStatus('dashboardAccessStatus', 'success');

                    const features = data.data.features;
                    const permissions = data.data.permissions;

                    updateSystemInfo(`üéõÔ∏è DASHBOARD ACCESS SUCCESS!\nüë§ User: ${data.data.user.fullName}\nüé≠ Role: ${data.data.user.role}\n\nüîß Available Features:\n${Object.entries(features).map(([key, value]) => `  ${value ? '‚úÖ' : '‚ùå'} ${key}`).join('\n')}\n\nüõ°Ô∏è Permissions: ${permissions.join(', ')}\n\n‚è∞ ${new Date().toLocaleString()}`);

                } else {
                    throw new Error(data.message || 'Dashboard access failed');
                }
            } catch (error) {
                updateStatus('dashboardAccessStatus', 'error');
                updateSystemInfo(`‚ùå Dashboard access failed: ${error.message}\n‚è∞ ${new Date().toLocaleString()}`);
            }
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.classList.remove('active', 'completed');
            if (status !== 'pending') {
                step.classList.add(status);
            }
        }

        function updateStatus(statusId, status) {
            const element = document.getElementById(statusId);
            element.classList.remove('status-success', 'status-error', 'status-pending');
            element.classList.add(`status-${status}`);

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                pending: '‚è≥'
            };

            element.textContent = icons[status] || '‚è≥';
        }

        function updateSystemInfo(info) {
            document.getElementById('systemOutput').textContent = info;
        }
    </script>
</body>

</html>
